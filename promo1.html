<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register or Login</title>
    <style>
        .hidden {
            display: none;
        }
        #error-msg {
            color: red;
        }
    </style>
</head>
<body>
    <div>
        <label for="email">E-Mail:</label>
        <input type="email" id="email" placeholder="E-Mail eingeben">
    </div>
    <div id="username-group" class="hidden">
        <label for="username">Benutzername:</label>
        <input type="text" id="username" placeholder="Benutzername eingeben">
    </div>
    <button id="submit-btn">Absenden</button>
    <p id="error-msg"></p>
    <div id="user-info" class="hidden">
        <p id="welcome-msg"></p>
        <p>Punkte: <span id="score"></span></p>
    </div>
    <script>
        const emailInput = document.getElementById("email");
        const usernameInput = document.getElementById("username");
        const submitBtn = document.getElementById("submit-btn");
        const usernameGroup = document.getElementById("username-group");
        const errorMsg = document.getElementById("error-msg");
        const userInfo = document.getElementById("user-info");
        const welcomeMsg = document.getElementById("welcome-msg");
        const scoreElement = document.getElementById("score");

        submitBtn.addEventListener("click", async () => {
            const email = emailInput.value.trim();
            const username = usernameInput.value.trim();

            if (!email) {
                errorMsg.textContent = "E-Mail ist erforderlich!";
                return;
            }

            errorMsg.textContent = "";

            try {
                const response = await fetch("https://fadedmarket.nand339.workers.dev/api/register-or-login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, username: username || null }),
                });

                const data = await response.json();

                if (response.status === 400 && data.error === "Username required for new registration") {
                    usernameGroup.classList.remove("hidden");
                    errorMsg.textContent = data.error;
                } else if (response.ok) {
                    usernameGroup.classList.add("hidden");
                    userInfo.classList.remove("hidden");
                    welcomeMsg.textContent = `Willkommen, ${data.username}!`;
                    scoreElement.textContent = data.score;

                    emailInput.value = "";
                    usernameInput.value = "";
                } else {
                    errorMsg.textContent = data.error || "Etwas ist schiefgelaufen!";
                }
            } catch (error) {
                errorMsg.textContent = "Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.";
            }
        });
    </script>
</body>
</html>
